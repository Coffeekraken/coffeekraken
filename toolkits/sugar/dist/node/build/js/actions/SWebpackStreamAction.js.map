{"version":3,"sources":["SWebpackStreamAction.js"],"names":["__webpack","require","__getFilename","__packageRoot","__deepMerge","__fs","__path","__SActionsStreamAction","__SBuildJsCli","__sugarConfig","__babel","__getScssImportsStrings","__jsObjectToScssMap","module","exports","settings","id","streamObj","babel","webpack","scss","Config","imports","resolve","reject","pack","Array","isArray","indexOf","input","log","replace","result","transformAsync","data","cwd","__dirname","filename","sourceMaps","catch","error","code","map","sourcemapData","scssImportsString","scssConfig","config","webpackSettings","Object","assign","compiler","mode","prod","entry","stats","errors","errorDetails","output","path","outputDir","rules","test","use","loader","options","implementation","prependData","prepend","exclude","presets","targets","esmodules","resolveLoader","modules","relative","process","symlinks","extensions","target","devtool","context","run","hasErrors","sts","toJson","console","hasWarnings","warnings","readFileSync","sourcemapOutput","definitionObj"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAMA,SAAS,GAAGC,OAAO,CAAC,SAAD,CAAzB;;AACA,MAAMC,aAAa,GAAGD,OAAO,CAAC,sBAAD,CAA7B;;AACA,MAAME,aAAa,GAAGF,OAAO,CAAC,2BAAD,CAA7B;;AACA,MAAMG,WAAW,GAAGH,OAAO,CAAC,2BAAD,CAA3B;;AACA,MAAMI,IAAI,GAAGJ,OAAO,CAAC,IAAD,CAApB;;AACA,MAAMK,MAAM,GAAGL,OAAO,CAAC,MAAD,CAAtB;;AACA,MAAMM,sBAAsB,GAAGN,OAAO,CAAC,sCAAD,CAAtC;;AACA,MAAMO,aAAa,GAAGP,OAAO,CAAC,gBAAD,CAA7B;;AACA,MAAMQ,aAAa,GAAGR,OAAO,CAAC,uBAAD,CAA7B;;AACA,MAAMS,OAAO,GAAGT,OAAO,CAAC,aAAD,CAAvB;;AACA,MAAMU,uBAAuB,GAAGV,OAAO,CAAC,kCAAD,CAAvC;;AACA,MAAMW,mBAAmB,GAAGX,OAAO,CAAC,8BAAD,CAAnC;AAEA;;;;;;;;;;;;;;;AAaAY,MAAM,CAACC,OAAP;AAAA;;AAAA;;AACE;;;;;;;;;;AAaA;;;;;;;;;AASA,gCAAYC,QAAZ,EAA2B;AAAA,QAAfA,QAAe;AAAfA,MAAAA,QAAe,GAAJ,EAAI;AAAA;;AAAA;;AAAA,6BAEvBX,WAAW,CACT;AACEY,MAAAA,EAAE,EAAE;AADN,KADS,EAITD,QAJS,CAFY;AAS1B;AAED;;;;;;;;;;;AAlCF;AAAA;AAAA,wBA2CME,SA3CN,EA2CiBF,QA3CjB,EA2C2B;AACvBA,MAAAA,QAAQ,GAAGX,WAAW,CACpB;AACEc,QAAAA,KAAK,EAAET,aAAa,CAAC,OAAD,CADtB;AAEEU,QAAAA,OAAO,EAAEV,aAAa,CAAC,SAAD,CAFxB;AAGEW,QAAAA,IAAI,EAAE;AACJC,UAAAA,MAAM,EAAE,EADJ;AAEJC,UAAAA,OAAO,EAAE;AAFL;AAHR,OADoB,EASpBP,QAToB,CAAtB;AAYA,2FAAiBE,SAAjB,EAA4B,OAAOM,OAAP,EAAgBC,MAAhB,KAA2B;AACrD;AACA,YACEP,SAAS,CAACQ,IAAV,KAAmB,KAAnB,IACCC,KAAK,CAACC,OAAN,CAAcV,SAAS,CAACQ,IAAxB,KACCR,SAAS,CAACQ,IAAV,CAAeG,OAAf,CAAuBX,SAAS,CAACY,KAAjC,MAA4C,CAAC,CAHjD,EAIE;AACA,eAAKC,GAAL,CACG,6EAA4Eb,SAAS,CAACY,KAAV,CAAgBE,OAAhB,CAC3E5B,aAAa,EAD8D,EAE3E,EAF2E,CAG3E,sDAJJ;AAOA,gBAAM6B,MAAM,GAAG,MAAMtB,OAAO,CACzBuB,cADkB,CACHhB,SAAS,CAACiB,IADP,EACa;AAC9BC,YAAAA,GAAG,EAAEhC,aAAa,CAACiC,SAAD,CADY;AAE9BC,YAAAA,QAAQ,EAAEpB,SAAS,CAACoB,QAFU;AAG9BC,YAAAA,UAAU,EAAE,IAHkB;AAI9B,eAAGvB,QAAQ,CAACG;AAJkB,WADb,EAOlBqB,KAPkB,CAOXC,KAAD,IAAW;AAChB,mBAAOhB,MAAM,CAACgB,KAAD,CAAb;AACD,WATkB,CAArB;AAWAvB,UAAAA,SAAS,CAACiB,IAAV,GAAiBF,MAAM,CAACS,IAAxB;;AACA,cAAIxB,SAAS,CAACyB,GAAV,IAAiBV,MAAM,CAACU,GAA5B,EAAiC;AAC/BzB,YAAAA,SAAS,CAAC0B,aAAV,GAA0BX,MAAM,CAACU,GAAjC;AACD;;AAED,iBAAOnB,OAAO,CAACN,SAAD,CAAd;AACD;;AAED,cAAM2B,iBAAiB,GAAGjC,uBAAuB,CAACI,QAAQ,CAACK,IAAT,CAAcE,OAAf,CAAjD;;AAEA,cAAMuB,UAAU,GAAGjC,mBAAmB,CACpCH,aAAa,CAAC,MAAD,CADuB,EAEpCM,QAAQ,CAACK,IAAT,CAAc0B,MAFsB,CAAtC;;AAKA,aAAKhB,GAAL,CACG,qEAAoEb,SAAS,CAACY,KAAV,CAAgBE,OAAhB,CACnE5B,aAAa,EADsD,EAEnE,EAFmE,CAGnE,SAJJ;AAOA,YAAI4C,eAAe,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBlC,QAAQ,CAACI,OAA3B,CAAtB;;AACA,cAAM+B,QAAQ,GAAGlD,SAAS,CACxBI,WAAW,CACT;AACE+C,UAAAA,IAAI,EAAElC,SAAS,CAACmC,IAAV,GAAiB,YAAjB,GAAgC,aADxC;AAEEC,UAAAA,KAAK,EAAEpC,SAAS,CAACY,KAFnB;AAGEyB,UAAAA,KAAK,EAAE;AACLC,YAAAA,MAAM,EAAE,IADH;AAELC,YAAAA,YAAY,EAAE;AAFT,WAHT;AAOEC,UAAAA,MAAM,EAAE;AACNC,YAAAA,IAAI,EAAEzC,SAAS,CAAC0C,SADV;AAENtB,YAAAA,QAAQ,EAAEpB,SAAS,CAACmC,IAAV,GACNlD,aAAa,CAACe,SAAS,CAACY,KAAX,CAAb,CAA+BE,OAA/B,CAAuC,KAAvC,EAA8C,UAA9C,CADM,GAEN7B,aAAa,CAACe,SAAS,CAACY,KAAX;AAJX,WAPV;AAaEhB,UAAAA,MAAM,EAAE;AACN+C,YAAAA,KAAK,EAAE,CACL;AACEC,cAAAA,IAAI,EAAE,aADR;AAEEC,cAAAA,GAAG,EAAE,CACH;AACA,4BAFG,EAGH;AACA,0BAJG,EAKH;AACA;AACEC,gBAAAA,MAAM,EAAE,aADV;AAEEC,gBAAAA,OAAO,EAAE;AACPC,kBAAAA,cAAc,EAAEhE,OAAO,CAAC,MAAD,CADhB;AAEPiE,kBAAAA,WAAW,EAAG;4BACVrB,UAAW;4BACXD,iBAAiB,CAACuB,OAAQ;;AAJvB;AAFX,eANG;AAFP,aADK,EAqBL;AACEN,cAAAA,IAAI,EAAE,SADR;AAEEO,cAAAA,OAAO,EAAE,iCAFX;AAGEN,cAAAA,GAAG,EAAE;AACHC,gBAAAA,MAAM,EAAE,cADL;AAEHC,gBAAAA,OAAO,EAAE;AACP7B,kBAAAA,GAAG,EAAEhC,aAAa,CAACiC,SAAD,CADX;AAEPiC,kBAAAA,OAAO,EAAE,CACP,CACE,mBADF,EAEE;AACEC,oBAAAA,OAAO,EAAE;AACPC,sBAAAA,SAAS,EAAE;AADJ;AADX,mBAFF,CADO,CAFF;AAYP,qBAAGxD,QAAQ,CAACG;AAZL;AAFN;AAHP,aArBK,EA0CL;AACE2C,cAAAA,IAAI,EAAE,SADR;AAEEC,cAAAA,GAAG,EAAE,WAFP;AAGEM,cAAAA,OAAO,EAAE;AAHX,aA1CK;AADD,WAbV;AA+DEI,UAAAA,aAAa,EAAE;AACbC,YAAAA,OAAO,EAAE,CACN,cADM,EAEPnE,MAAM,CAACoE,QAAP,CACEvE,aAAa,CAACwE,OAAO,CAACxC,GAAR,EAAD,CADf,EAEG,GAAEhC,aAAa,CAACiC,SAAD,CAAY,eAF9B,CAFO;AADI,WA/DjB;AAwEEb,UAAAA,OAAO,EAAE;AACPqD,YAAAA,QAAQ,EAAE,IADH;AAEPC,YAAAA,UAAU,EAAE,CAAC,MAAD,EAAS,KAAT,EAAgB,KAAhB,CAFL;AAGPJ,YAAAA,OAAO,EAAE,CACP,cADO,EAEP,QAFO,EAGPnE,MAAM,CAACoE,QAAP,CACEvE,aAAa,CAACwE,OAAO,CAACxC,GAAR,EAAD,CADf,EAEG,GAAEhC,aAAa,CAACiC,SAAD,CAAY,eAF9B,CAHO;AAHF,WAxEX;AAoFE0C,UAAAA,MAAM,EAAE,KApFV;AAqFEC,UAAAA,OAAO,EAAE9D,SAAS,CAACyB,GAAV,GAAgB,YAAhB,GAA+B,KArF1C;AAsFEsC,UAAAA,OAAO,EAAE7E,aAAa,CAACwE,OAAO,CAACxC,GAAR,EAAD;AAtFxB,SADS,EAyFTY,eAzFS,CADa,CAA1B;;AA8FAG,QAAAA,QAAQ,CAAC+B,GAAT,CAAa,CAACzC,KAAD,EAAQc,KAAR,KAAkB;AAC7B,cAAIA,KAAK,CAAC4B,SAAN,EAAJ,EAAuB;AACrB,kBAAMC,GAAG,GAAG7B,KAAK,CAAC8B,MAAN,EAAZ;AACAC,YAAAA,OAAO,CAAC7C,KAAR,CAAc2C,GAAG,CAAC5B,MAAlB;AACA,mBAAO/B,MAAM,CAAC2D,GAAG,CAAC5B,MAAL,CAAb;AACD;;AACD,cAAID,KAAK,CAACgC,WAAN,EAAJ,EAAyB;AACvB,kBAAMH,GAAG,GAAG7B,KAAK,CAAC8B,MAAN,EAAZ;AACAC,YAAAA,OAAO,CAAC7C,KAAR,CAAc2C,GAAG,CAACI,QAAlB;AACA,mBAAO/D,MAAM,CAAC2D,GAAG,CAACI,QAAL,CAAb;AACD,WAV4B,CAY7B;;;AACA,gBAAM9B,MAAM,GAAGpD,IAAI,CAACmF,YAAL,CACblF,MAAM,CAACiB,OAAP,CAAeN,SAAS,CAAC0C,SAAzB,EAAoCzD,aAAa,CAACe,SAAS,CAACY,KAAX,CAAjD,CADa,EAEb,MAFa,CAAf,CAb6B,CAkB7B;;;AACA,cAAI4D,eAAJ;;AACA,cAAIxE,SAAS,CAACyB,GAAd,EAAmB;AACjB+C,YAAAA,eAAe,GAAGpF,IAAI,CAACmF,YAAL,CAChBlF,MAAM,CAACiB,OAAP,CACEN,SAAS,CAAC0C,SADZ,EAEEzD,aAAa,CAACe,SAAS,CAACY,KAAX,CAAb,GAAiC,MAFnC,CADgB,EAKhB,MALgB,CAAlB;AAOD,WA5B4B,CA8B7B;;;AACAZ,UAAAA,SAAS,CAACiB,IAAV,GAAiBuB,MAAjB;AACA,cAAIgC,eAAJ,EAAqBxE,SAAS,CAAC0B,aAAV,GAA0B8C,eAA1B;AAErBlE,UAAAA,OAAO,CAACN,SAAD,CAAP;AACD,SAnCD;AAoCD,OAlLD;AAmLD;AA3OH;;AAAA;AAAA,EAAoDV,sBAApD,4CAUyB,EACrB,GAAGC,aAAa,CAACkF;AADI,CAVzB","sourcesContent":["const __webpack = require('webpack');\nconst __getFilename = require('../../../fs/filename');\nconst __packageRoot = require('../../../path/packageRoot');\nconst __deepMerge = require('../../../object/deepMerge');\nconst __fs = require('fs');\nconst __path = require('path');\nconst __SActionsStreamAction = require('../../../stream/SActionsStreamAction');\nconst __SBuildJsCli = require('../SBuildJsCli');\nconst __sugarConfig = require('../../../config/sugar');\nconst __babel = require('@babel/core');\nconst __getScssImportsStrings = require('../../scss/getScssImportsStrings');\nconst __jsObjectToScssMap = require('../../scss/jsObjectToScssMap');\n\n/**\n * @name                SWebpackStreamAction\n * @namespace           node.build.js.actions\n * @type                Class\n * @extends             SActionsStreamAction\n *\n * This function is responsible of passing webpack on the output files\n *\n * @param       {Object}Â        streamObj          The streamObj object with the properties described bellow:\n * @return      {Promise}                         A simple promise that will be resolved when the process is finished\n *\n * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n */\nmodule.exports = class SWebpackStreamAction extends __SActionsStreamAction {\n  /**\n   * @name            definitionObj\n   * @type             Object\n   * @static\n   *\n   * Store the definition object that specify the streamObj required properties, types, etc...\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  static definitionObj = {\n    ...__SBuildJsCli.definitionObj\n  };\n\n  /**\n   * @name            constructor\n   * @type            Function\n   * @constructor\n   *\n   * Constructor\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  constructor(settings = {}) {\n    super(\n      __deepMerge(\n        {\n          id: 'actionStream.action.js.webpack'\n        },\n        settings\n      )\n    );\n  }\n\n  /**\n   * @name          run\n   * @type          Function\n   * @async\n   *\n   * Override the base class run method\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  run(streamObj, settings) {\n    settings = __deepMerge(\n      {\n        babel: __sugarConfig('babel'),\n        webpack: __sugarConfig('webpack'),\n        scss: {\n          Config: {},\n          imports: null\n        }\n      },\n      settings\n    );\n\n    return super.run(streamObj, async (resolve, reject) => {\n      // pass over this action if we don't want to pack the files\n      if (\n        streamObj.pack === false ||\n        (Array.isArray(streamObj.pack) &&\n          streamObj.pack.indexOf(streamObj.input) === -1)\n      ) {\n        this.log(\n          `Skipping the <yellow>webpack</yellow> packaging action for the file <cyan>${streamObj.input.replace(\n            __packageRoot(),\n            ''\n          )}</cyan> and processing file using <cyan>babel</cyan>`\n        );\n\n        const result = await __babel\n          .transformAsync(streamObj.data, {\n            cwd: __packageRoot(__dirname),\n            filename: streamObj.filename,\n            sourceMaps: true,\n            ...settings.babel\n          })\n          .catch((error) => {\n            return reject(error);\n          });\n\n        streamObj.data = result.code;\n        if (streamObj.map && result.map) {\n          streamObj.sourcemapData = result.map;\n        }\n\n        return resolve(streamObj);\n      }\n\n      const scssImportsString = __getScssImportsStrings(settings.scss.imports);\n\n      const scssConfig = __jsObjectToScssMap(\n        __sugarConfig('scss'),\n        settings.scss.config\n      );\n\n      this.log(\n        `Processing the <yellow>webpack</yellow> action for the file <cyan>${streamObj.input.replace(\n          __packageRoot(),\n          ''\n        )}</cyan>`\n      );\n\n      let webpackSettings = Object.assign({}, settings.webpack);\n      const compiler = __webpack(\n        __deepMerge(\n          {\n            mode: streamObj.prod ? 'production' : 'development',\n            entry: streamObj.input,\n            stats: {\n              errors: true,\n              errorDetails: true\n            },\n            output: {\n              path: streamObj.outputDir,\n              filename: streamObj.prod\n                ? __getFilename(streamObj.input).replace('.js', '.prod.js')\n                : __getFilename(streamObj.input)\n            },\n            module: {\n              rules: [\n                {\n                  test: /\\.s[ac]ss$/i,\n                  use: [\n                    // Creates `style` nodes from JS strings\n                    'style-loader',\n                    // Translates CSS into CommonJS\n                    'css-loader',\n                    // Compiles Sass to CSS\n                    {\n                      loader: 'sass-loader',\n                      options: {\n                        implementation: require('sass'),\n                        prependData: `\n                          ${scssConfig}\n                          ${scssImportsString.prepend}\n                        `\n                      }\n                    }\n                  ]\n                },\n                {\n                  test: /\\.m?js$/,\n                  exclude: /(node_modules|bower_components)/,\n                  use: {\n                    loader: 'babel-loader',\n                    options: {\n                      cwd: __packageRoot(__dirname),\n                      presets: [\n                        [\n                          '@babel/preset-env',\n                          {\n                            targets: {\n                              esmodules: true\n                            }\n                          }\n                        ]\n                      ],\n                      ...settings.babel\n                    }\n                  }\n                },\n                {\n                  test: /\\.tsx?$/,\n                  use: 'ts-loader',\n                  exclude: /node_modules/\n                }\n              ]\n            },\n            resolveLoader: {\n              modules: [\n                `node_modules`,\n                __path.relative(\n                  __packageRoot(process.cwd()),\n                  `${__packageRoot(__dirname)}/node_modules`\n                )\n              ]\n            },\n            resolve: {\n              symlinks: true,\n              extensions: ['.tsx', '.ts', '.js'],\n              modules: [\n                'node_modules',\n                'src/js',\n                __path.relative(\n                  __packageRoot(process.cwd()),\n                  `${__packageRoot(__dirname)}/node_modules`\n                )\n              ]\n            },\n            target: 'web',\n            devtool: streamObj.map ? 'source-map' : false,\n            context: __packageRoot(process.cwd())\n          },\n          webpackSettings\n        )\n      );\n\n      compiler.run((error, stats) => {\n        if (stats.hasErrors()) {\n          const sts = stats.toJson();\n          console.error(sts.errors);\n          return reject(sts.errors);\n        }\n        if (stats.hasWarnings()) {\n          const sts = stats.toJson();\n          console.error(sts.warnings);\n          return reject(sts.warnings);\n        }\n\n        // reading the outputed file\n        const output = __fs.readFileSync(\n          __path.resolve(streamObj.outputDir, __getFilename(streamObj.input)),\n          'utf8'\n        );\n\n        // check if is a sourcemap\n        let sourcemapOutput;\n        if (streamObj.map) {\n          sourcemapOutput = __fs.readFileSync(\n            __path.resolve(\n              streamObj.outputDir,\n              __getFilename(streamObj.input) + '.map'\n            ),\n            'utf8'\n          );\n        }\n\n        // // if (!streamObj.dataBefore) streamObj.dataBefore = {};\n        streamObj.data = output;\n        if (sourcemapOutput) streamObj.sourcemapData = sourcemapOutput;\n\n        resolve(streamObj);\n      });\n    });\n  }\n};\n"]}
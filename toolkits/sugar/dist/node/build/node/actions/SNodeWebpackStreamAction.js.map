{"version":3,"sources":["SNodeWebpackStreamAction.js"],"names":["__webpack","require","__getFilename","__packageRoot","__deepMerge","__fs","__path","__SActionsStreamAction","__SBuildNodeCli","__sugarConfig","__babel","__tmpDir","__childProcess","module","exports","settings","id","streamObj","babel","resolve","reject","trigger","input","slice","tmpDir","filePath","outFilePath","log","replace","console","writeFileSync","data","childProcess","execSync","cwd","readFileSync","result","transformAsync","__dirname","filename","sourceMaps","presets","targets","node","catch","error","code","map","sourcemapData","definitionObj"],"mappings":"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","sourcesContent":["const __webpack = require('webpack');\nconst __getFilename = require('../../../fs/filename');\nconst __packageRoot = require('../../../path/packageRoot');\nconst __deepMerge = require('../../../object/deepMerge');\nconst __fs = require('fs');\nconst __path = require('path');\nconst __SActionsStreamAction = require('../../../stream/SActionsStreamAction');\nconst __SBuildNodeCli = require('../SBuildNodeCli');\nconst __sugarConfig = require('../../../config/sugar');\nconst __babel = require('@babel/core');\nconst __tmpDir = require('../../../fs/tmpDir');\nconst __childProcess = require('child_process');\n\n/**\n * @name                SNodeWebpackStreamAction\n * @namespace           node.build.node.actions\n * @type                Class\n * @extends             SActionsStreamAction\n *\n * This function is responsible of passing webpack on the output files\n *\n * @param       {Object}Â        streamObj          The streamObj object with the properties described bellow:\n * @return      {Promise}                         A simple promise that will be resolved when the process is finished\n *\n * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n */\nmodule.exports = class SNodeWebpackStreamAction extends __SActionsStreamAction {\n  /**\n   * @name            definitionObj\n   * @type             Object\n   * @static\n   *\n   * Store the definition object that specify the streamObj required properties, types, etc...\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  static definitionObj = {\n    ...__SBuildNodeCli.definitionObj\n  };\n\n  /**\n   * @name            constructor\n   * @type            Function\n   * @constructor\n   *\n   * Constructor\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  constructor(settings = {}) {\n    super(\n      __deepMerge(\n        {\n          id: 'actionStream.action.node.webpack'\n        },\n        settings\n      )\n    );\n  }\n\n  /**\n   * @name          run\n   * @type          Function\n   * @async\n   *\n   * Override the base class run method\n   *\n   * @author    Olivier Bossel <olivier.bossel@gmail.com> (https://olivierbossel.com)\n   */\n  run(streamObj, settings) {\n    settings = __deepMerge(\n      {\n        babel: __sugarConfig('babel')\n      },\n      settings\n    );\n\n    return super.run(streamObj, async (resolve, reject, trigger) => {\n      if (streamObj.input.slice(-2) === 'ts') {\n        // saving the file to render it\n        const tmpDir = __tmpDir();\n        const filePath = `${tmpDir}/${__getFilename(streamObj.input)}`;\n        const outFilePath = `${filePath}.out`;\n\n        this.log(\n          `Precessing the typescript file \"<cyan>${streamObj.input.replace(\n            `${__packageRoot()}/`,\n            ''\n          )}</cyan>\"...`\n        );\n\n        console.log('XXX');\n\n        __fs.writeFileSync(filePath, streamObj.data);\n\n        // compiling the file\n        const childProcess = __childProcess.execSync(\n          `npx tsc --outFile ${outFilePath} ${filePath}`,\n          {\n            cwd: __packageRoot()\n          }\n        );\n\n        streamObj.data = __fs.readFileSync(outFilePath, 'utf8');\n\n        return resolve(streamObj);\n      }\n\n      this.log(\n        `Precessing the javascript file \"<cyan>${streamObj.input.replace(\n          `${__packageRoot()}/`,\n          ''\n        )}</cyan>\"...`\n      );\n\n      const result = await __babel\n        .transformAsync(streamObj.data, {\n          cwd: __packageRoot(__dirname),\n          filename: streamObj.filename,\n          sourceMaps: true,\n          presets: [\n            [\n              '@babel/preset-env',\n              {\n                targets: {\n                  node: 'current'\n                }\n              }\n            ]\n          ],\n          ...settings.babel\n        })\n        .catch((error) => {\n          return reject(error);\n        });\n\n      streamObj.data = result.code;\n      if (streamObj.map && result.map) {\n        streamObj.sourcemapData = result.map;\n      }\n\n      return resolve(streamObj);\n    });\n  }\n};\n"]}